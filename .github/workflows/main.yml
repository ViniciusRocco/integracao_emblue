name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/master'

    steps:
      - uses: actions/checkout@v2
      
      - name: Install Node.js 
      
        uses: actions/setup-node@v2
        with: 
          node-version: '16'
    
      - name: 'Create env file'
        uses: SpicyPizza/create-envfile@v1.3
        with:          
          envkey_JET_ENDPOINT: "${{ secrets.JET_ENDPOINT }}"
          envkey_JET_USERNAME: "${{ secrets.JET_USERNAME }}"
          envkey_JET_PASSWORD: "${{ secrets.JET_PASSWORD }}"
          envkey_JET_INTEGRATION_KEY: "${{ secrets.JET_INTEGRATION_KEY }}"
          envkey_JET_STORE_ID: "${{ secrets.JET_STORE_ID }}"
          envkey_EMBLUE_TOKEN: "${{ secrets.EMBLUE_TOKEN }}"
          envkey_EMBLUE_USERNAME: "${{ secrets.EMBLUE_USERNAME }}"    
          envkey_EMBLUE_PASSWORD: "${{ secrets.EMBLUE_PASSWORD }}"
          envkey_EMBLUE_ENDPOINT: "${{ secrets.EMBLUE_ENDPOINT }}"
          envkey_EMBLUE_TRACKENDPOINT: "${{ secrets.EMBLUE_TRACKENDPOINT }}"
          envkey_TIMEOUT_API: "${{ secrets.TIMEOUT_API }}"       
          envkey_TRACK_AUTH_TOKEN: "${{ secrets.TRACK_AUTH_TOKEN }}"      
          envkey_EMBLUE_EVENT_NAME: "${{ secrets.EMBLUE_EVENT_NAME }}"
          envkey_IS_LOCAL: "${{ secrets.IS_LOCAL }}"                                   
          directory: ./
          fail_on_empty: true
          
      - name: rsync deployments
        uses: burnett01/rsync-deployments@5.1
        with: 
          switches: -avzr --delete
          path: ./*
          remote_path: /var/www/up2you/
          remote_host: ec2-3-86-212-88.compute-1.amazonaws.com
          remote_user: ec2-user
          remote_key: "${{ secrets.SSH_PRIVATE_KEY }}"

      - run: npm i

      - run: ls -al